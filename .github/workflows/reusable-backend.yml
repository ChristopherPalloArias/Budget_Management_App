name: Reusable Backend Workflow

on:
  workflow_call:
    inputs:
      java-version:
        required: false
        type: string
        default: '17'
      pom-dir:
        required: true
        type: string
    secrets:
      SONAR_TOKEN:
        required: true
      SONAR_HOST_URL:
        required: true
      # Add any needed secrets here

jobs:
  validate-and-test:
    name: Backend Validate & Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      issues: write
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: test_db
          MYSQL_USER: testuser
          MYSQL_PASSWORD: testpass
          MYSQL_ROOT_PASSWORD: testpass
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports:
          - 3306:3306
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'temurin'

      - name: Install Backend Dependencies
        run: mvn dependency:resolve
        working-directory: ${{ inputs.pom-dir }}
        continue-on-error: true

      - name: Quality Checks (Checkstyle, SpotBugs, PMD)
        run: |
          mvn checkstyle:check || true
          mvn spotbugs:check || true
          mvn pmd:check || true
        working-directory: ${{ inputs.pom-dir }}

      - name: Run Backend Unit Tests
        run: mvn test
        working-directory: ${{ inputs.pom-dir }}
        id: backend_tests
        continue-on-error: true
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/test_db
          SPRING_DATASOURCE_USERNAME: testuser
          SPRING_DATASOURCE_PASSWORD: testpass
          SPRING_JPA_HIBERNATE_DDL_AUTO: create-drop

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-results
          path: ${{ inputs.pom-dir }}/target/surefire-reports/
          retention-days: 30
          if-no-files-found: ignore

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: ${{ inputs.pom-dir }}/target/surefire-reports/TEST-*.xml
          check_name: 'Backend Unit Tests'
          comment_mode: always
        continue-on-error: true

      - name: Create Issue on Failure
        if: steps.backend_tests.outcome == 'failure' && github.ref == 'refs/heads/develop'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = github.ref == 'refs/heads/develop' ? 'develop' : context.ref.replace('refs/heads/', '');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üêõ Backend Tests Failed - ' + branchName,
              body: 'Automated report: Backend tests failed in the ' + branchName + ' branch. Check workflow logs for details.',
              labels: ['bug', 'automated-report']
            });
