name: CI - Pull Request

on:
  pull_request:
    branches:
      - main
      - develop
      - 'feature/**'

jobs:
  detect:
    name: Detect Project Structure
    runs-on: ubuntu-latest
    outputs:
      has_backend: ${{ steps.detect.outputs.has_backend }}
      pom_dir: ${{ steps.detect.outputs.pom_dir }}
      has_frontend: ${{ steps.detect.outputs.has_frontend }}
      frontend_dir: './app/Frontend'
    steps:
      - uses: actions/checkout@v4
      - id: detect
        run: |
          if find . -name 'pom.xml' -not -path '*/target/*' | grep -q .; then
            POM_PATH=$(find . -name 'pom.xml' -not -path '*/target/*' | head -1)
            echo "has_backend=true" >> "$GITHUB_OUTPUT"
            echo "pom_dir=$(dirname "$POM_PATH")" >> "$GITHUB_OUTPUT"
          else
            echo "has_backend=false" >> "$GITHUB_OUTPUT"
          fi
          if [ -f "app/Frontend/package.json" ]; then
            echo "has_frontend=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_frontend=false" >> "$GITHUB_OUTPUT"
          fi

  backend:
    needs: detect
    if: needs.detect.outputs.has_backend == 'true'
    uses: ./.github/workflows/reusable-backend.yml
    with:
      pom-dir: ${{ needs.detect.outputs.pom_dir }}

  frontend:
    needs: detect
    if: needs.detect.outputs.has_frontend == 'true'
    uses: ./.github/workflows/reusable-frontend.yml
    with:
      frontend-dir: ${{ needs.detect.outputs.frontend_dir }}
